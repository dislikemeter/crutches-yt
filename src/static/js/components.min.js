var store=new Vuex.Store({state:{user:{},modules:[],tags:null},mutations:{setUser:function(t,e){t.user=e},passChange:function(t){t.user.passExpireDate=null},setModules:function(t,e){t.modules=e},toggleFav:function(t,e){var i=t.modules.indexOf(e.module);t.modules[i].fav=!!e.fav},loadTags:function(t){t.tags||axios.get("/api/tags").then(function(e){e.data&&Array.isArray(e.data)&&(t.tags=e.data)})},addtag:function(t,e){if(!isNaN(e.id)&&Array.isArray(t.tags)){for(var i=0;i<t.tags.length;i++)if(t.tags[i].id===e.id)return;t.tags.push(e)}}}}),dashboardIcon={admin:"i-gear",media:"i-media",account:"i-user"},components={notFound:Vue.component("not-found",{template:'<div class="absolute-center window"><div class="sim-table"><div class="container"><img src="/static/img/elf.png"></div><div class="container"><h1>{{$root.msg(\'not-found\')}}</h1><p>{{$root.msg(\'nothing-here\')}}</p><p><span class="pseudo-link" @click="returnClick">{{$root.msg(\'go-back\')}}</span></p><p><router-link to="/">{{$root.msg(\'main-page\')}}</router-link></p></div></div></div>',data:function(){return{}},methods:{returnClick:function(){this.$router.go(-1)}},mounted:function(){this.$root.setTitle("not-found")}}),modalWindow:Vue.component("modal-window",{template:'<div id="modal-layer" class="full" :class="{active:isActive}" @scroll="onScroll" @click="onClick"><div class="widget window absolute-center"><div class="window-head"><h1>{{title}}</h1></div><div class="container"><p v-html="content"></p><div class="btn-container"><button v-for="(button, index) in buttons" :class="button.class" @click="exit(index)"><i v-if="button.icon" :class="button.icon + \' icon at-left\'"></i>{{ button.name }}</button></div></div></div></div>',data:function(){return{isActive:!1,title:"",content:"",buttons:[]}},methods:{onScroll:function(t){t.preventDefault()},onClick:function(t){t.target===this.$el&&this.exit(0)},show:function(t){this.isActive||(this.title=this.$root.msgf(t.title),this.content=this.$root.msgf(t.content),this.buttons=t.buttons,this.buttons.forEach(function(t){t.name=this.$root.msgf(t.name)},this),this.isActive=!0)},exit:function(t){this.$root.$emit("modalExit",t),this.isActive=!1}},created:function(){this.$root.$on("modal",this.show);var t=this;this.$root.$on("keydown",function(e){27===e.keyCode&&t.exit(-1)})}}),sideMenu:Vue.component("side-menu",{template:'<div><label for="mainmenu"><img src="/static/img/menu.svg"></label><router-link id="logo" to="/" class="clearfix"><img src="/static/img/logo_l.png" alt="logo"></router-link><input id="mainmenu" class="menu" type="checkbox"><div class="mobile-menu"><nav><router-link to="/account"><img class="small avatar" :src="user.avatar" alt="Profile icon"><i v-if="user.passExpireDate" class="red led at-right"></i> {{user.firstName}}</router-link><hr><p v-show="favorites.length===0" class="align-center"><em>{{$root.msg(\'favorites\')}}</em></p><router-link v-for="fav in favorites" :to="fav.path" :key="fav.id"><i id="profile-icon" class="icon at-left" :class="icon(fav.catId)"></i> {{$root.msg(fav.name)}}</router-link><hr><a href="/logout"><i class="icon i-logout at-left"></i> {{$root.msg(\'logout\')}}</a></nav></div></div>',data:function(){return{}},computed:{user:function(){return store.state.user},favorites:function(){return store.state.modules.filter(function(t){return t.fav})}},methods:{icon:function(t){return dashboardIcon[t]}}}),sidebarLayout:Vue.component("sidebar-layout",{template:'<div class="full"><modal-window/><div id="page" class="full"><aside><side-menu></side-menu></aside><section id="main"><div class="container"><router-view/></div></section></div></div>',data:function(){return{}},created:function(){axios.get("/api/myprofile").then(function(t){t.data&&store.commit("setUser",t.data)}),axios.get("/api/dashboard").then(function(t){t.data&&store.commit("setModules",t.data)})}}),viewProfile:Vue.component("view-profile",{template:'<div><div><h1>{{fullName}}</h1></div><div class="stack mt"><div class="widget window"><div class="window-head"><h2>{{$root.msg(\'profile\')}}</h2></div><div class="container"><div class="align-center"><img class="big avatar" :src="user.avatar" alt="Profile photo"></div><p>Email / login: <strong>{{user.email}}</strong></p><p>{{$root.msg(\'phone\')}}: <strong>{{user.phone}}</strong></p><p><router-link to="/account/edit"><i class="icon i-pen at-left"></i>{{$root.msg(\'edit\')}}</router-link></p></div></div><div class="widget window"><div class="window-head"><h2>{{$root.msg(\'account\')}}</h2></div><div class="container"><p class="employee-position">{{$root.msg(\'role\')}}: <strong>{{user.roleName}}</strong></p><p>{{$root.msg(\'registered\')}} <strong><datetime only="date" :value="user.registeredDate"/></strong></p><p v-if="user.expireDate">{{$root.msg(\'expire\')}} <strong><datetime only="date" :value="user.expireDate"/></strong></p><p>{{$root.msg(\'pass-changed\')}} <strong><datetime only="date" :value="user.passChangeDate"/></strong><span v-if="user.credentialsExpireDate">,<br>{{$root.msg(\'expire\')}} <strong class="errortext"><datetime only="date" :value="user.credentialsExpireDate"/></strong></span></p><p><router-link to="/account/password"><i class="icon i-lock at-left"></i>{{$root.msg(\'change-pass\')}}</router-link></p></div></div></div></div>',data:function(){return{}},computed:{user:function(){return store.state.user},fullName:function(){var t=((this.user.lastName||"")+" "+this.user.firstName+" "+(this.user.middleName||"")).trim();return this.$root.setTitle(t),t}}}),editProfile:Vue.component("edit-profile",{template:'<div><div><h1>{{$root.msg(\'edit\')}} {{$root.msg(\'profile\')}}</h1></div><div class="stack mt"><div class="widget window"><div class="window-head"><h2>{{$root.msg(\'first-name\')}}</h2></div><div class="container"><form action="/api/myprofile" method="POST" @submit.prevent="submit"><p>Email: <strong>{{post.email}}</strong></p><input type="text" name="lastName" v-model="post.lastName" :class="{error: errorIn(\'lastName\')}" :placeholder="$root.msg(\'last-name\')"><input type="text" name="firstName" v-model="post.firstName" :class="{error: errorIn(\'firstName\')}" :placeholder="$root.msg(\'first-name\')"><input type="text" name="middleName" v-model="post.middleName" :class="{error: errorIn(\'middleName\')}" :placeholder="$root.msg(\'middle-name\')"><input type="tel" name="phone" v-model="post.phone" :class="{error: errorIn(\'phone\')}" :placeholder="$root.msg(\'phone\')"><div class="btn-container"><button type="submit" :disabled="invalid || blocked"><i class="icon i-disk at-left"></i>Save changes</button></div></form></div></div><div class="widget window"><div class="window-head"><h2>{{$root.msg(\'avatar\')}}</h2></div><div class="container align-center"><img class="big avatar" :src="post.avatar" alt="avatar"></div></div></div><p><router-link to="/account"><i class="icon i-back at-left"></i>{{$root.msg(\'cancel\')}}</router-link></p></div>',data:function(){return{post:{},errorFields:[],ajaxErrorFields:[],blocked:!1}},computed:{invalid:function(){return this.errorFields=[],/^[a-zа-я]{4,32}$/i.test(this.post.firstName)||this.errorFields.push("firstName"),/^[a-zа-я]{4,32}$/i.test(this.post.lastName)||this.errorFields.push("lastName"),/(^[a-zа-я]{4,32}$)|(^$)/i.test(this.post.middleName)||this.errorFields.push("middleName"),/(^\+?\d{7,20}$)|(^$)/i.test(this.post.phone)||this.errorFields.push("phone"),!!this.errorFields.length}},methods:{submit:function(){if(!this.invalid){this.blocked=!0,this.ajaxErrorFields=[];var t=this;axios.post("/api/myprofile",this.post).then(function(e){if(!e.data.modal)throw t.$root.msg("connection-error");t.$root.$on("modalExit",function(e){t.$root.$off("modalExit"),1===e&&t.$router.push("/account"),t.blocked=!1}),store.commit("setUser",t.post),t.$root.$emit("modal",e.data.modal)}).catch(function(e){e.response&&e.response.data&&e.response.data.errorFields?t.ajaxErrorFields=e.response.data.errorFields:modalError(e),t.blocked=!1})}},errorIn:function(t){return this.errorFields.indexOf(t)>=0||this.ajaxErrorFields.indexOf(t)>=0}},created:function(){this.post=JSON.parse(JSON.stringify(store.state.user))},mounted:function(){this.$root.setTitle("profile")}}),changePassword:Vue.component("change-password",{template:'<div class="centered widget window"><div class="align-center window-head"><h1>{{$root.msg(\'change-pass\')}}</h1></div><div class="container"><form action="/api/password" method="POST" @submit.prevent="submit"><p>{{$root.msg(\'old-password\')}}</p><input name="password" required autofocus="autofocus" type="password" v-model="post.password" :class="{error: errorIn(\'password\')}"><p>{{$root.msg(\'new-password\')}}</p><input v-if="showPassword" name="new-password" required type="text" v-model="post.newPassword" :class="{error: errorIn(\'newPassword\')}"><input v-else name="new-password" required type="password" v-model="post.newPassword" :class="{error: errorIn(\'newPassword\')}"><label><input type="checkbox" v-model="showPassword"><i></i>{{$root.msg(\'show-password\')}}</label><div class="btn-container"><button type="submit" :disabled="invalid || blocked"><i class="icon i-disk at-left"></i>{{$root.msg(\'save\')}}</button></div><p><router-link to="/account"><i class="icon i-back at-left"></i>{{$root.msg(\'cancel\')}}</router-link></p></form></div></div>',data:function(){return{post:{password:"",newPassword:""},showPassword:!1,errorFields:[],ajaxErrorFields:[],blocked:!1}},computed:{invalid:function(){return this.errorFields=[],/^[\w:;.,!@#$%^&*(){}]{8,64}$/.test(this.post.password)||this.errorFields.push("password"),!!this.errorFields.length},inputType:function(){return this.showPassword?"text":"password"}},methods:{submit:function(){if(!this.invalid){this.blocked=!0,this.ajaxErrorFields=[];var t=this;axios.post("/api/password",this.post).then(function(e){if(!e.data.modal)throw t.$root.msg("connection-error");t.$root.$on("modalExit",function(e){t.$root.$off("modalExit"),1===e&&t.$router.push("/account"),t.blocked=!1,t.post.password="",t.post.newPassword=""}),store.commit("passChange"),t.$root.$emit("modal",e.data.modal)}).catch(function(e){e.response&&e.response.data&&e.response.data.errorFields?t.ajaxErrorFields=e.response.data.errorFields:modalError(e),t.blocked=!1})}},errorIn:function(t){return this.errorFields.indexOf(t)>=0||this.ajaxErrorFields.indexOf(t)>=0}},mounted:function(){this.$root.setTitle("change-pass")}}),selectList:Vue.component("select-list",{template:'<div class="ui-select"><input v-if="find" v-model="filterString" type="text" :placeholder="searchph || \'...\'"><ul><li v-for="item, index in items" v-show="isMatchingFilter(item)" :class="{active: isActive(index)}" @click="toggleItem(index)"><span>{{item.name ? item.name : item}}</span></li></ul></div>',props:["items","multiselect","find","searchph","value"],data:function(){return{filterString:""}},computed:{filterToLower:function(){return this.filterString.toLowerCase()}},methods:{isActive:function(t){return-1!==this.value.indexOf(t)},isMatchingFilter:function(t){return 0===this.filterString.length||-1!==(t.name?t.name.toLowerCase():JSON.stringify(t).toLowerCase()).indexOf(this.filterToLower)},toggleItem:function(t){var e=this.value,i=e.indexOf(t);-1===i?this.multiselect?e.push(t):e=[t]:this.multiselect?e.splice(i,1):e=[],this.$emit("input",e)}},watch:{items:function(){this.$emit("input",[])}}}),editRoles:Vue.component("edit-roles",{template:'<div class="stack" :class="{loader:loading}"><div><h2>{{$root.msg(\'roles\')}}</h2><select-list :items="roles" v-model="selectedRoles" @input="roleSelect" :searchph="$root.msg(\'filter\')" find="true"></select-list><input type="text" v-model="roleName" :placeholder="$root.msg(\'name\')"><div class="btn-container"><button :disabled="!roleNameIsValid || roleExists" @click="addRole"><i class="icon i-plus at-left"></i>{{$root.msg(\'add\')}}</button><button :disabled="!roleNameIsValid || !selectedRole" @click="saveRole"><i class="icon i-disk at-left"></i>{{$root.msg(\'save\')}}</button><button :disabled="!selectedRole" @click="deleteRole"><i class="icon i-trash at-left"></i>{{$root.msg(\'delete\')}}</button></div></div><div class="widget"><h2>{{$root.msg(\'linked-permissions\')}}</h2><select-list v-model="selectedPermissions" :items="permissions" :searchph="$root.msg(\'filter\')" multiselect="true" find="true"></select-list></div></div>',data:function(){return{roles:[],permissions:[],selectedRoles:[],selectedPermissions:[],roleName:"",rolesLoading:!0,permLoading:!0}},computed:{selectedRole:function(){return 1===this.selectedRoles.length?this.roles[this.selectedRoles[0]]:null},selectedRoleIndex:function(){return 1===this.selectedRoles.length?this.selectedRoles[0]:null},selectedPermissionsIds:function(){var t=this;return this.selectedPermissions.map(function(e){return t.permissions[e].id})},roleNameIsValid:function(){return/^[a-z_]+$/i.test(this.roleName)},roleExists:function(){var t=this;return this.roles.some(function(e){return e.name.toLowerCase===t.roleName.toLowerCase()})},loading:function(){return this.rolesLoading||this.permLoading}},methods:{addRole:function(){var t=this;axios.post("/api/roles",{roleName:this.roleName,linkedPermissions:this.selectedPermissionsIds}).then(function(e){e.data&&(t.roles=t.roles.concat(e.data),t.roleName="")}).catch(function(t){modalError(t)})},saveRole:function(){var t=this,e=this.selectedRoleIndex;axios.post("/api/roles/"+this.selectedRole.id,{roleName:this.roleName,linkedPermissions:this.selectedPermissionsIds}).then(function(i){i.data&&Vue.set(t.roles,e,i.data[0])}).catch(function(t){modalError(t)})},deleteRole:function(){var t=this,e=this.selectedRoleIndex;axios.delete("/api/roles/"+this.selectedRole.id).then(function(i){t.roleName="",t.roles.splice(e,1)}).catch(function(t){modalError(t)})},roleSelect:function(){var t=this,e=[];this.roleName=this.selectedRole?this.selectedRole.name:"",this.selectedRole&&this.permissions.forEach(function(i,s){-1!==t.selectedRole.linkedPermissions.indexOf(i.id)&&e.push(s)}),this.selectedPermissions=e}},created:function(){var t=this;axios.get("/api/permissions").then(function(e){200===e.status&&e.data&&(t.permissions=e.data,t.permLoading=!1)}),axios.get("/api/roles").then(function(e){200===e.status&&e.data&&(t.roles=e.data,t.rolesLoading=!1)})},mounted:function(){this.$root.setTitle("roles")}}),editPermissions:Vue.component("edit-permissions",{template:'<div :class="{loader:loading}"><h2>{{$root.msg(\'permissions\')}}</h2><select-list :items="permissions" v-model="selectedPermissions" @input="permissionSelect" :searchph="$root.msg(\'filter\')" find="true"></select-list><input type="text" v-model="permissionName" :placeholder="$root.msg(\'name\')"><div class="btn-container"><button :disabled="!permissionNameIsValid || permissionExists" @click="addPermission"><i class="icon i-plus at-left"></i>{{$root.msg(\'add\')}}</button><button :disabled="!permissionNameIsValid || !selectedPermission" @click="savePermission"><i class="icon i-disk at-left"></i>{{$root.msg(\'save\')}}</button><button :disabled="!selectedPermission" @click="deletePermission"><i class="icon i-trash at-left"></i>{{$root.msg(\'delete\')}}</button></div></div>',data:function(){return{permissions:[],selectedPermissions:[],permissionName:"",loading:!0}},computed:{selectedPermission:function(){return 1===this.selectedPermissions.length?this.permissions[this.selectedPermissions[0]]:null},selectedPermissionIndex:function(){return 1===this.selectedPermissions.length?this.selectedPermissions[0]:null},permissionNameIsValid:function(){return/^[a-z_]+$/i.test(this.permissionName)},permissionExists:function(){var t=this;return this.permissions.some(function(e){return e.name.toLowerCase===t.permissionName.toLowerCase()})}},methods:{permissionSelect:function(){this.permissionName=this.selectedPermission?this.selectedPermission.name:""},addPermission:function(){var t=this;axios.post("/api/permissions",{permissionName:this.permissionName}).then(function(e){e.data&&(t.permissions=t.permissions.concat(e.data),t.permissionName="")}).catch(function(t){modalError(t)})},savePermission:function(){var t=this,e=this.selectedPermissionIndex;axios.post("/api/permissions/"+this.selectedPermission.id,{permissionName:this.permissionName}).then(function(i){i.data&&Vue.set(t.permissions,e,i.data[0])}).catch(function(t){modalError(t)})},deletePermission:function(){var t=this,e=this.selectedPermissionIndex;axios.delete("/api/permissions/"+this.selectedPermission.id).then(function(i){t.permissions.splice(e,1),t.permissionName=""}).catch(function(t){modalError(t)})}},created:function(){var t=this;axios.get("/api/permissions").then(function(e){200===e.status&&e.data&&(t.permissions=e.data,t.loading=!1)})},mounted:function(){this.$root.setTitle("permissions")}}),datetime:Vue.component("datetime",{template:"<span>{{dateTime}}</span>",props:["value","only"],computed:{dateTime:function(){return!this.value||isNaN(this.value)?"–":moment(this.value).calendar()}}}),datepicker:Vue.component("datepicker",{template:'<div class="datepicker" :class="{active:isOpen}" :disabled="disabled" @focus="focus" @blur="blur"><div class="dateholder"><datetime only="date" :value="value"></datetime></div><div v-if="!disabled" class="picker-popup"><div><select class="il" v-model="selectedMonth" @blur="blur"><option v-for="month, index in monthNames" :value="index">{{month}}</option></select><select class="il" v-model="selectedYear" @blur="blur"><option v-for="year in 131" :value="1969+year">{{1969 + year}}</option></select></div><div tabindex="0" class="calendar" @keydown="calendarKey" @blur="blur"><span v-for="n in daysGap"></span><span v-for="day in daysCount" class="day" :class="{active: day === selectedDay, current: isCurrent(day)}" @click="selectedDay = day">{{day}}</span></div><p class="align-center pseudo-link" @click="selectCurrent">{{$root.msg(\'today\')}}</p></div></div>',props:["value","disabled"],data:function(){return{monthNames:this.$root.msg("months"),selectedDate:new Date(0),currentDate:new Date,firstDay:this.$root.msg("firstDay"),isOpen:!1}},watch:{value:function(t){t=t||new Date,this.selectedDate=t.getTime?t:"number"==typeof t?new Date(t):new Date(parseInt(t))},disabled:function(t){t?this.$el.removeAttribute("tabindex"):this.$el.setAttribute("tabindex",0)}},computed:{selectedDay:{get:function(){return this.selectedDate.getDate()},set:function(t){var e=new Date(this.selectedDate.valueOf());e.setDate(t),this.$emit("input",e.valueOf())}},selectedMonth:{get:function(){return this.selectedDate.getMonth()},set:function(t){var e=new Date(this.selectedDate.valueOf());e.setMonth(t),this.$emit("input",e.valueOf())}},selectedYear:{get:function(){return this.selectedDate.getFullYear()},set:function(t){var e=new Date(this.selectedDate.valueOf());e.setFullYear(t),this.$emit("input",e.valueOf())}},daysGap:function(){var t=new Date(this.selectedDate.valueOf());t.setDate(1);var e=t.getDay()-this.firstDay;return e<0&&(e+=7),e},daysCount:function(){switch(this.selectedMonth){case 1:return this.selectedYear%400==0?29:this.selectedYear%100==0?28:this.selectedYear%4==0?29:28;case 3:case 5:case 8:case 10:return 30;default:return 31}},currentDay:function(){return this.currentDate.getDate()},currentMonth:function(){return this.currentDate.getMonth()},currentYear:function(){return this.currentDate.getFullYear()}},methods:{selectCurrent:function(){this.disabled||(this.$emit("input",this.currentDate.valueOf()),this.$el.blur())},isCurrent:function(t){return this.selectedDate.getFullYear()===this.currentDate.getFullYear()&&this.selectedDate.getMonth()===this.currentDate.getMonth()&&t===this.currentDate.getDate()},calendarKey:function(t){var e=this.selectedDate,i=0;switch(t.keyCode){case 37:i=-1;break;case 38:i=-7;break;case 39:i=1;break;case 40:i=7}e.setDate(e.getDate()+i),this.$emit("input",e.valueOf())},focus:function(){this.isOpen=!0},blur:function(){var t=this;setTimeout(function(){t.isOpen=!(t.$el!==document.activeElement&&!t.$el.querySelector(":focus"))},100)}},mounted:function(){this.disabled?this.$el.removeAttribute("tabindex"):this.$el.setAttribute("tabindex",0)}}),editUsers:Vue.component("edit-users",{template:'<div :class="{loader:loading}"><div><h1>{{$root.msg(\'edit-users\')}}</h1></div><div class="table-container mt"><div><table><thead><tr><th class="col-half"><div>{{$root.msg(\'first-name\')}}</div></th><th><div>Email</div></th><th><div>{{$root.msg(\'role\')}}</div></th><th><div>{{$root.msg(\'active\')}}</div></th><th><div>{{$root.msg(\'delete\')}}</div></th></tr></thead><tbody><tr class="clickable" v-for="user, index in users" @click="selectUserForEdit(user, index)"><td>{{(user.lastName ? user.lastName + \' \' : \'\') + user.firstName + \' \' + (user.middleName ? user.middleName + \' \' : \'\') | trim}}</td><td>{{user.email}}</td><td>{{roleName(user.roleId)}}</td><td class="align-center"><i class="icon" :class="{\'i-ok\': user.enabled, \'i-cancel\': !user.enabled}"></i></td><td class="align-center"><i class="clickable icon i-trash" @click="deleteUser(index)"></i></td></tr></tbody></table></div></div><div class="mt window"><div class="window-head"><h2>{{createMode ? $root.msg(\'new-account\') : $root.msg(\'edit\') + \': \' + editUser.email}}</h2></div><div class="container stack"><div class="widget"><h2>{{$root.msg(\'account\')}}</h2><input type="email" v-model="editUser.email" placeholder="Email" required><select v-model="editUser.roleId"><option v-for="role in roles" :value="role.id">{{role.name}}</option></select><label><input type="checkbox" v-model="editUser.enabled"><i></i>{{$root.msg(\'active\')}}</label><label><input type="checkbox" :checked="!!editUser.expireDate" @change="setAccountExpire"><i></i>{{$root.msg(\'expire\')}}: </label><datepicker v-show="!!editUser.expireDate" v-model="editUser.expireDate"></datepicker></div><div class="widget"><h2>{{$root.msg(\'profile\')}}</h2><input type="text" v-model="editUser.firstName" :placeholder="$root.msg(\'first-name\')" required><input type="text" v-model="editUser.lastName" :placeholder="$root.msg(\'last-name\')"><input type="text" v-model="editUser.middleName" :placeholder="$root.msg(\'middle-name\')"><input type="text" v-model="editUser.phone" :placeholder="$root.msg(\'phone\')"><div class="btn-container"><button @click="save"><i class="icon i-disk at-left"></i>{{$root.msg(\'save\')}}</button><button :disabled="createMode" @click="selectUserForEdit(null)"><i class="icon i-cancel at-left"></i>{{$root.msg(\'cancel\')}}</button></div></div><div v-show="!createMode" class="widget"><h2>{{$root.msg(\'actions\')}}</h2><p class="pseudo-link" @click="reset"><i class="icon i-lock at-left"></i>{{$root.msg(\'reset-pass\')}}</p><p class="pseudo-link" @click="expire"><i class="icon i-logout at-left"></i>{{$root.msg(\'logout\')}}</p><h2>{{$root.msg(\'stats\')}}</h2><p>{{$root.msg(\'registered\')}}: <datetime only="date" :value="editUser.registeredDate"></datetime></p><p>{{$root.msg(\'pass-changed\')}}: <datetime only="date" :value="editUser.passChangeDate"></datetime></p><p>{{$root.msg(\'pass-expire\')}}: <datetime only="date" :value="editUser.passExpireDate"></datetime></p></div></div></div></div>',data:function(){return{users:[],roles:[],currentUserIndex:null,editUser:{},rolesLoading:!0,usersLoading:!1}},computed:{createMode:function(){return null===this.currentUserIndex},loading:function(){return this.rolesLoading||this.usersLoading}},methods:{newUser:function(){this.currentUserIndex=null,this.editUser.email="",this.editUser.roleId=null,this.editUser.enabled=!0,this.editUser.expireDate=null,this.editUser.firstName="",this.editUser.lastName="",this.editUser.middleName="",this.editUser.phone=""},selectUserForEdit:function(t,e){t?(this.currentUserIndex=e,this.editUser=JSON.parse(JSON.stringify(t))):this.newUser()},roleName:function(t){for(var e=0;e<this.roles.length;e++)if(this.roles[e].id===t)return this.roles[e].name},setAccountExpire:function(t){this.editUser.expireDate=t.target.checked?(new Date).getTime()+864e5:null},save:function(){var t=this,e=this.currentUserIndex;this.createMode?axios.post("/api/users",this.editUser).then(function(e){t.users=t.users.concat(e.data),t.newUser()}).catch(function(e){e.response&&e.response.data&&e.response.data.errorFields?(t.ajaxErrorFields=e.response.data.errorFields,modalError(e)):modalError(e)}):axios.post("/api/users/"+this.editUser.id,this.editUser).then(function(i){t.users[e]=i.data[0],t.newUser()}).catch(function(e){e.response&&e.response.data&&e.response.data.errorFields?(t.ajaxErrorFields=e.response.data.errorFields,modalError(e)):modalError(e)})},deleteUser:function(t){var e=this;axios.delete("/api/users/"+this.users[t].id).then(function(i){e.users.splice(t,1)}).catch(function(t){t.response&&t.response.data&&t.response.data.errorFields?(e.ajaxErrorFields=t.response.data.errorFields,modalError(t)):modalError(t)})},reset:function(){axios.post("/api/users/resetpass/"+this.editUser.id,{})},expire:function(){axios.post("/api/users/expire/"+this.editUser.id,{})}},filters:{trim:function(t){return t.trim()}},created:function(){this.newUser();var t=this;axios.get("/api/roles").then(function(e){200===e.status&&e.data&&(t.roles=e.data,t.rolesLoading=!1)}),axios.get("/api/users").then(function(e){200===e.status&&e.data&&(t.users=e.data,t.usersLoading=!1)})},mounted:function(){this.$root.setTitle("edit-users")}}),carousel:Vue.component("carousel",{template:'<div class="carousel" @mouseenter="update"><div v-if="!noButtons"><div class="like-button left" @click="scrollLeft" :disabled="disableLeft"><i class="icon i-left"></i></div><div class="like-button right" @click="scrollRight" :disabled="disableRight"><i class="icon i-right"></i></div></div><div class="cutter" @wheel.prevent="wheel"><div class="row" :class="{spaced: spaced}" :style="styleObject" ref="row"><slot></slot></div></div></div>',props:["noButtons","initScroll","spaced"],data:function(){return{scroll:0,disableLeft:!0,disableRight:!1}},computed:{styleObject:function(){return{transform:"translateX(-"+this.scroll+"px)"}}},methods:{scrollOffset:function(t){var e=this.$refs.row.scrollWidth-this.$el.clientWidth;this.scroll=Math.max(Math.min(this.scroll+t,e),0),this.disableLeft=this.scroll<=0,this.disableRight=this.scroll>=e},scrollLeft:function(){this.scrollOffset(-this.$el.clientWidth/1.5)},scrollRight:function(){this.scrollOffset(this.$el.clientWidth/1.5)},wheel:function(t){var e=Math.min(Math.max(t.deltaY>50?3*t.deltaY:100*t.deltaY,-300),300);this.scrollOffset(e)},update:function(){this.scrollOffset(0)}},mounted:function(){this.initScroll&&this.scrollOffset(this.initScroll)}}),taglist:Vue.component("taglist",{template:'<div class="il"><span v-if="!readonly" class="tag"><label><i class="icon i-plus"></i><input class="il ml" :style="newTagWidth" v-model="name" @change="addTag" maxlength=32></label></span><span v-for="tag in actualTags" class="tag" @click="tagClick(tag)"><em class="mr">{{tag.name}}</em><i v-if="!readonly" class="icon i-cancel" @click.stop="unbindTag(tag.id)"></i></span></div>',props:["readonly","tags"],data:function(){return{name:""}},computed:{newTagWidth:function(){return{width:.5*(1+this.name.length)+"em"}},actualTags:function(){if(store.commit("loadTags"),store.state.tags){var t=this;return store.state.tags.filter(function(e){return t.tags.indexOf(e.id)>-1})}}},methods:{addTag:function(){this.readonly||this.name.length>0&&(this.$emit("addtag",this.name),this.name="")},unbindTag:function(t){this.readonly||this.$emit("unbindtag",t)},tagClick:function(t){this.$emit("tagclick",t)}}}),ytStats:Vue.component("ytstats",{template:'<div :class="{loader:loading}"><div class="clearfix" ref="heading"><h1>{{$root.msg(\'ytstats\')}}</h1><div class="il at-right"><label class="icon il"><i class="icon" :class="!filter.length ? \'i-filter\' : \'i-cancel\'" @click="clearFilter"></i><input v-model.lazy="filter" :placeholder="$root.msg(\'filter\')" :class="{\'on-demand\': !filter.length}"></label><label class="icon il ml"><i class="icon i-plus"></i><input v-model.lazy="newVideoUrl" :placeholder="$root.msg(\'add-video\')"></label></div></div><div class="mt"><carousel ref="carousel"><div v-for="item, index in items" v-show="isMatchingFilter(item)" class="yt-stat align-center" :class="{active: currentVideo ? item.id===currentVideo.id : false}"><div class="rec-indicator" v-show="item.watched"><i class="icon i-rec"></i></div><img :src="thumbs[index]" class="clickable" @click="seeStats(index)"><div v-if="item.control" class="yt-btn btn-container"><button @click="toggleWatching(index)"><i class="icon" :class="item.watched ? \'i-stop\' : \'i-rec\'"></i></button></div></div></carousel></div><hr><div v-show="!!currentVideo" class="mt" ref="chart"><div class="clearfix"><h2><i class="icon i-stat"></i> {{$root.msg(\'stats\')}}</h2><div class="at-right"><select class="mr il" v-model.number="tension"><optgroup :label="$root.msg(\'line-mode\')"><option value="0">{{$root.msg(\'polygonal-chain\')}}</option></optgroup><optgroup :label="$root.msg(\'spline-curve\')"><option selected value="0.1">20%</option><option value="0.2">40%</option><option value="0.3">60%</option><option value="0.4">80%</option><option value="0.5">100%</option></optgroup></select><select class="mr il" v-model.number="approx"><optgroup :label="$root.msg(\'approx\')"><option value="0">10 sec</option><option value="3" :disabled="statInterval < 2">30 sec</option><option value="6" :disabled="statInterval < 5">1 min</option><option value="18" :disabled="statInterval < 15">3 min</option><option value="30" :disabled="statInterval < 30">5 min</option><option value="60" :disabled="statInterval < 60">10 min</option></optgroup></select><select class="mr il" v-model="mode"><option value="absolute">{{$root.msg(\'chart-mode\')[0]}}</option><option value="delta">{{$root.msg(\'chart-mode\')[1]}}</option></select><button :disabled="!videoId" @click="updateCurrentChart"><i class="icon i-refresh at-left"></i>{{$root.msg(\'update\')}}</button></div></div><div class="chart"><canvas ref="canvas" id="chart"></canvas></div><div class="mt"><h2>{{$root.msg(\'video\')}}</h2></div><div class="mt clearfix"><div class="at-right" v-if="currentVideo ? currentVideo.control : false"><label class="il mr"><input type="checkbox" v-model="sharedMode">{{$root.msg(\'open-stat\')}}<i class="ml"></i></label><button class="red" @click="deleteVideo"><i class="icon i-trash at-left"></i>{{$root.msg(\'delete\')}}</button></div><p>{{$root.msg(\'added-person\')}}<span class="ml mr">{{currentVideo ? currentVideo.owner : \'\'}}</span><datetime :value="currentVideo ? currentVideo.date : null" /></p><p><taglist :readonly="currentVideo ? !currentVideo.control : true" :tags="currentVideo ? currentVideo.tags : []" @addtag="addTag" @unbindtag="unbindTag" @tagclick="setFilterTag" /></p></div><div class="videowrap mt"><iframe :src="embedUrl"></iframe></div></div></div>',props:["videoId"],data:function(){return{items:null,chart:null,newVideoUrl:"",loading:!0,tension:.1,filter:"",mode:"absolute",approx:0,fetchedData:{timestamps:[],likeCount:[],dislikeCount:[],commentCount:[],viewCount:[]}}},computed:{thumbs:function(){return this.items.map(function(t){return"https://img.youtube.com/vi/"+t.videoId+"/mqdefault.jpg"})},invalidLink:function(){return!/^https?:\/\/(www\.)?youtube\.com\/watch\?(.*&)?v=([a-zA-Z0-9_-]{10,12}).*$/.test(this.newVideoUrl)},currentVideo:function(){if(!isNaN(this.videoId)&&this.videoId>0&&Array.isArray(this.items))for(var t=this.items.length-1;t>=0;t--)if(this.items[t].id==this.videoId)return this.items[t]},embedUrl:function(){return this.currentVideo?"https://www.youtube.com/embed/"+this.currentVideo.videoId:""},sharedMode:{get:function(){return!!this.currentVideo&&this.currentVideo.shared},set:function(t){var e=this.currentVideo;axios.post("/api/ytstats/"+this.currentVideo.id+"/share",{state:t}).then(function(i){e.shared=t})}},statInterval:function(){return this.fetchedData.timestamps.length<2?0:Math.round((this.fetchedData.timestamps[this.fetchedData.timestamps.length-1]-this.fetchedData.timestamps[0])/6e4)},processedData:function(){var t,e=function(t,e,i){return t-(i[e-1]||t)},i=function(t,e){if(!Array.isArray(t)||0==t.length)return[];var i=[];i.push(t[0]);for(var s=0;s<t.length;s+=e){var a,o=0;for(a=0;a<e&&!isNaN(t[s+a]);a++)o+=t[s+a];o=Math.round(o/a*100)/100,i.push(o)}return i.push(t[t.length-1]),i};switch(this.mode){case"delta":var s=this.fetchedData.likeCount.map(e),a=this.fetchedData.dislikeCount.map(e),o=this.fetchedData.commentCount.map(e),n=this.fetchedData.viewCount.map(e);t={timestamps:this.fetchedData.timestamps,likeCount:s,dislikeCount:a,commentCount:o,viewCount:n};break;default:t=this.fetchedData}if(this.approx){var r=i(t.likeCount,this.approx),l=i(t.dislikeCount,this.approx),d=i(t.commentCount,this.approx),c=i(t.viewCount,this.approx);t={timestamps:function(t,e){if(!Array.isArray(t)||0==t.length||e<2)return[];var i=[];if(i.push(t[0]),e>2)for(var s=(t.length-1)/(e-1),a=s;Math.round(a)<t.length-1;a+=s)i.push(t[Math.round(a)]);return i.push(t[t.length-1]),i}(t.timestamps,r.length),likeCount:r,dislikeCount:l,commentCount:d,viewCount:c}}return t},lastTimestamp:function(){return this.fetchedData.timestamps.length>0?Math.max.apply(null,this.fetchedData.timestamps):0}},methods:{clearFilter:function(){this.filter=""},loadDataToChart:function(){this.chart.data.labels=this.processedData.timestamps,this.chart.data.datasets[0].data=this.processedData.commentCount,this.chart.data.datasets[1].data=this.processedData.dislikeCount,this.chart.data.datasets[2].data=this.processedData.likeCount,this.chart.data.datasets[3].data=this.processedData.viewCount,this.chart.update(0)},isMatchingFilter:function(t){return this.filter.length<1||!store.state.tags||t.tags.map(function(t){for(var e=0;e<store.state.tags.length;e++)if(store.state.tags[e].id==t)return store.state.tags[e].name;return""}).join("").toLowerCase().indexOf(this.filter.toLowerCase())>-1},toggleWatching:function(t){var e=this;axios.post("/api/ytstats/"+this.items[t].id,{status:!e.items[t].watched}).then(function(i){i.data&&(e.items[t].watched=i.data.capturing)})},loadChart:function(t){if(isNaN(t))this.$router.push("/ytstats");else{this.approx=0;var e=this;axios.get("/api/ytstats/"+t).then(function(t){t.data&&(e.fetchedData=t.data,e.loadDataToChart())}).catch(function(){e.$router.push("/ytstats")})}},updateCurrentChart:function(){var t=this;axios.get("/api/ytstats/"+this.videoId+"?from="+this.lastTimestamp).then(function(e){e.data&&e.data.timestamps.length>0&&(t.fetchedData.timestamps=t.fetchedData.timestamps.concat(e.data.timestamps),t.fetchedData.likeCount=t.fetchedData.likeCount.concat(e.data.likeCount),t.fetchedData.dislikeCount=t.fetchedData.dislikeCount.concat(e.data.dislikeCount),t.fetchedData.commentCount=t.fetchedData.commentCount.concat(e.data.commentCount),t.fetchedData.viewCount=t.fetchedData.viewCount.concat(e.data.viewCount),t.loadDataToChart())})},seeStats:function(t){this.items[t].id==this.videoId?this.$refs.chart.scrollIntoView():this.$router.push("/ytstats/"+this.items[t].id)},addTag:function(t){var e=this;axios.post("/api/ytstats/"+this.currentVideo.id+"/tag",{action:"bind",name:t}).then(function(t){t.data&&!isNaN(t.data.id)&&(store.commit("addtag",t.data),-1===e.currentVideo.tags.indexOf(t.data.id)&&e.currentVideo.tags.push(t.data.id))})},unbindTag:function(t){var e=this;axios.post("/api/ytstats/"+this.currentVideo.id+"/tag",{action:"unbind",tag:t}).then(function(i){i.data&&e.currentVideo.tags.splice(e.currentVideo.tags.indexOf(t),1)})},deleteVideo:function(){var t=this;axios.delete("/api/ytstats/"+this.currentVideo.id).then(function(e){e.data&&t.items.splice(t.items.indexOf(t.currentVideo),1)})},setFilterTag:function(t){this.filter=t.name,this.filterItems(),this.$refs.heading.scrollIntoView()}},watch:{videoId:function(t){this.loadChart(t)},tension:function(t){this.chart&&(this.chart.options.elements.line.tension=t,this.chart.update())},newVideoUrl:function(t){if(!(t.length<1)){var e=this;axios.post("/api/ytstats",{url:t}).then(function(t){var i=t.data;i.watched=!1,e.items.unshift(i),e.newVideoUrl=""})}},mode:function(){this.loadDataToChart()},approx:function(){this.loadDataToChart()}},mounted:function(){this.$root.setTitle("ytstats");var t=this.$refs.canvas.getContext("2d"),e=this;this.chart=new Chart(t,{type:"line",data:{labels:[0],datasets:[{label:"Comments",backgroundColor:"rgba(255, 152, 0,.2)",borderColor:"rgb(255, 152, 0)",fill:!0,data:[0]},{label:"Dislikes",backgroundColor:"rgba(244, 67, 54,.2)",borderColor:"rgb(244, 67, 54)",fill:!0,data:[0]},{label:"Likes",backgroundColor:"rgba(3, 169, 244,.2)",borderColor:"rgb(3, 169, 244)",fill:!0,data:[0]},{label:"Views",backgroundColor:"rgba(158, 158, 158,.2)",borderColor:"rgb(158, 158, 158)",hidden:!0,fill:!0,data:[0]}]},options:{tooltips:{callbacks:{title:function(t,e){return moment(t[0].xLabel).calendar()}}},scales:{xAxes:[{type:"time"}],yAxes:[{startAtZero:!0}]},elements:{line:{tension:e.tension}}}}),axios.get("/api/ytstats").then(function(t){e.items=t.data.reverse(),e.loading=!1}),this.videoId&&this.loadChart(this.videoId)}}),dashboard:Vue.component("dashboard",{template:'<div><div><h1>{{$root.msg(\'dashboard\')}}</h1></div><div class="stack mt"><div v-for="moduleSet, catId in dashboard" class="widget"><h2>{{$root.msg(\'mod-cat\')[catId]}}</h2><div v-for="module in moduleSet" class="mt module"><i class="clickable icon at-left" :class="module.fav ? \'i-fav\' : \'i-nofav\'" @click="toggleFav(module)"></i><router-link :to="module.path">{{$root.msg(module.name)}}</router-link></div></div></div></div>',data:function(){return{}},computed:{dashboard:function(){var t={};return store.state.modules.forEach(function(e){t.hasOwnProperty(e.catId)||(t[e.catId]=[]),t[e.catId].push(e)},this),t}},methods:{toggleFav:function(t){axios.post("/api/dashboard/"+t.id,{}).then(function(e){store.commit("toggleFav",{module:t,fav:e.data.fav})})}},mounted:function(){this.$root.setTitle("dashboard")}}),editParams:Vue.component("edit-params",{template:'<div :class="{loader:loading}"><div><h1>{{$root.msg(\'config\')}}</h1></div><div class="table-container mt"><div><table><thead><tr><th class="col-half"><div>{{$root.msg(\'name\')}}</div></th><th><div>{{$root.msg(\'value\')}}</div></th><th class="col-small"></th></tr></thead><tbody><tr v-for="param, index in params"><td>{{param.name}}</td><td><input v-model="param.value" @change="postParam(index)"></td><td class="align-center"><i class="clickable icon i-trash" @click="deleteParam(index)"></i></td></tr></tbody></table></div></div><div class="widget mt"><h2>{{$root.msg(\'add\')}}</h2><input v-model="newName" :placeholder="$root.msg(\'name\')"><input v-model="newValue" :placeholder="$root.msg(\'value\')"><div class="btn-container"><button :disabled="invalid" @click="addParam"><i class="icon i-plus at-left"></i>{{$root.msg(\'add\')}}</button></div></div></div>',data:function(){return{params:[],newName:"",newValue:"",loading:!0}},created:function(){var t=this;axios.get("/api/config").then(function(e){e.data&&(t.params=e.data),t.loading=!1}).catch(function(e){t.loading=!1})},methods:{postParam:function(t){t<this.params.length&&axios.post("/api/config",{name:this.params[t].name,value:this.params[t].value})},deleteParam:function(t){var e=this;axios.delete("/api/config/"+this.params[t].id).then(function(i){i.data&&e.params.splice(t,1)})},addParam:function(){var t=this;axios.post("/api/config",{name:this.newName,value:this.newValue}).then(function(e){e.data&&e.data.id&&(t.params.push(e.data),t.newName="",t.newValue="")})}},computed:{invalid:function(){return!(this.newName.length&&this.newValue.length)}},mounted:function(){this.$root.setTitle("config")}})};